<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>DM File Sharing</title>
    <style>
        body {
            font-family: verdana;
        }
    </style>

</head>

<body>

    <!-- <a href="/.auth/login/aad?post_login_redirect_url=/">Log in with Azure AD</a>
    <a href="/.auth/me">Auth details</a> -->

    <div id="checkAuthPanel">Please wait while checking authentication status...</div>

    <div id="selectUploadPanel">

        <label for="fileInput">Choose a file to upload:</label>
        <input type="file" id="fileInput" name="avatar">

        <button onclick="upload()">Upload</button>
    </div>

    <div id="successPanel">
        <p>Download URL:</p>
        <div id="downloadUrl"></div>

        <p>Upload URL:</p>
        <div id="uploadUrl"></div>

        <p><code>azcopy cp SOURCE "UPLOAD_URL"</code></p>
    </div>

    <div id="errorPanel">
        <div id="errorMessage"></div>
    </div>

</body>

<script src="azure-storage.blob.min.js" charset="utf-8">
    //https://aka.ms/downloadazurestoragejs
</script>

<script>
    function docReady(cb) {
        if (document.readyState != 'loading') {
            cb();
        } else {
            document.addEventListener('DOMContentLoaded', cb);
        }
    }
    docReady(function () {
        document.getElementById("selectUploadPanel").style.display = 'none';
        document.getElementById("successPanel").style.display = 'none';
        document.getElementById("errorPanel").style.display = 'none';
        checkToken();
    });

    function checkToken() {
        fetch('.auth/me')
            .then(function (response) {
                if (response.status == 200) {
                    // token OK, show UI
                    response.json().then(function (data) {
                        console.log(data); // todo
                        // todo: get name           
                        document.getElementById("selectUploadPanel").style.display = 'block';
                    });
                    return;
                }
                else if (response.status == 401) {
                    // token not valid, redirect to login
                    window.location.href = "/.auth/login/aad";
                    return;
                }
                else
                    showError('<p>Looks like there was a problem checking token. Status Code: ' + response.status + ' ' + response.statusText + '</p><p><a href="/.auth/login/aad?post_login_redirect_url=/">Retry login</a></p>');
            })
            .catch(function (error) {
                showError(error);
            })
            .finally(function () {
                document.getElementById("checkAuthPanel").style.display = 'none';
            });
    }


    function upload() {
        document.getElementById("successPanel").style.display = 'none';
        document.getElementById("errorPanel").style.display = 'none';

        var file = document.getElementById('fileInput').files[0];
        if (file == undefined) {
            alert("please select a file");
            return;
        }

        fetch('./api/CreateUpload?filename=' + encodeURIComponent(file.name))
            .then(function (response) {

                if (response.status !== 200) {
                    showError('Looks like there was a problem. Status Code: ' + response.status + '' + response.statusText);
                    return;
                }

                response.json().then(function (data) {
                    console.log(data); // todo
                    document.getElementById("downloadUrl").innerHTML = data.downloadUrl;
                    document.getElementById("uploadUrl").innerHTML = data.uploadUrl;
                    document.getElementById("successPanel").style.display = 'block';

                    const blockBlobURL = new azblob.BlockBlobURL(data.uploadUrl,
                        azblob.StorageURL.newPipeline(new azblob.AnonymousCredential));

                    azblob.uploadBrowserDataToBlockBlob(
                        azblob.Aborter.none, file, blockBlobURL, {
                            // blockSize: file.size > 1024 * 1024 * 32 ? 1024 * 1024 * 4 : 1024 * 512,
                            progress: function(pe) {
                                console.log(pe.loadedBytes + ' of ' + file.size);
                            }
                        }).then(function (response) {
                            console.log("DONE ", response);
                        }, function (error) {
                            console.error("Failed!", error);
                        });
                });
            })
            .catch(function (error) {
                showError(error);
            });
    }

    function showError(error) {
        document.getElementById("errorMessage").innerHTML = error;
        document.getElementById("errorPanel").style.display = 'block';
    }

</script>

</html>